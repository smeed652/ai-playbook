{
  "version": "1.1",
  "description": "Sprint workflow step definitions for enforcement system",
  "phases": [
    {
      "phase": 1,
      "name": "Planning",
      "description": "Read sprint file, plan implementation, clarify requirements",
      "steps": [
        {
          "step": "1.1",
          "name": "Read Sprint File",
          "description": "Find and read the sprint planning document",
          "agent": null,
          "validation": {
            "type": "file_read",
            "check": "sprint_file in state"
          },
          "outputs": ["sprint_file", "sprint_title"]
        },
        {
          "step": "1.2",
          "name": "Spawn Plan Agent",
          "description": "Use Plan agent to design implementation approach",
          "agent": "Plan",
          "validation": {
            "type": "state_field",
            "check": "plan_output exists and has files_to_create"
          },
          "outputs": ["plan_output"]
        },
        {
          "step": "1.3",
          "name": "Clarify Requirements",
          "description": "Ask user questions about ambiguous requirements, edge cases, and preferences before implementation",
          "agent": null,
          "validation": {
            "type": "user_confirmation",
            "check": "user confirmed requirements are clear"
          },
          "outputs": ["clarifications"],
          "requires_user_input": true
        },
        {
          "step": "1.4",
          "name": "Mark Start",
          "description": "Update sprint file status to In Progress",
          "agent": null,
          "validation": {
            "type": "file_content",
            "check": "sprint file has Status: In Progress"
          },
          "outputs": []
        }
      ]
    },
    {
      "phase": 2,
      "name": "Test-First Implementation",
      "description": "Write tests, implement features, run tests, fix failures",
      "steps": [
        {
          "step": "2.1",
          "name": "Write Tests First (TDD)",
          "description": "Create test file with failing tests for sprint requirements",
          "agent": "product-engineer",
          "validation": {
            "type": "file_exists",
            "check": "tests/test_sprint{N}_*.py exists"
          },
          "outputs": ["test_file_path"]
        },
        {
          "step": "2.2",
          "name": "Implement Feature",
          "description": "Create/modify files identified by Plan agent",
          "agent": "product-engineer",
          "validation": {
            "type": "files_created",
            "check": "files from plan_output.files_to_create exist"
          },
          "outputs": ["implementation_files"]
        },
        {
          "step": "2.3",
          "name": "Run Tests",
          "description": "Execute tests and analyze results",
          "agent": "test-runner",
          "validation": {
            "type": "state_field",
            "check": "test_results exists"
          },
          "outputs": ["test_results"]
        },
        {
          "step": "2.4",
          "name": "Fix Failures",
          "description": "Fix any failing tests (skip if all pass)",
          "agent": "product-engineer",
          "validation": {
            "type": "test_status",
            "check": "test_results.failed == 0"
          },
          "outputs": [],
          "skippable_if": "test_results.failed == 0"
        }
      ]
    },
    {
      "phase": 3,
      "name": "Validation & Refactoring",
      "description": "Verify migrations, review quality, refactor code",
      "steps": [
        {
          "step": "3.1",
          "name": "Verify Migration",
          "description": "Check database migration applies cleanly",
          "agent": "Explore",
          "validation": {
            "type": "state_field",
            "check": "pre_flight_checklist.migrations_verified == true"
          },
          "outputs": [],
          "skippable_if": "no migration file created"
        },
        {
          "step": "3.2",
          "name": "Quality Review",
          "description": "Review code quality, type hints, docstrings",
          "agent": "quality-engineer",
          "validation": {
            "type": "state_field",
            "check": "pre_flight_checklist.code_has_docstrings == true"
          },
          "outputs": ["quality_issues"]
        },
        {
          "step": "3.3",
          "name": "Refactoring",
          "description": "Clean up code: reduce duplication, simplify complexity, improve naming, ensure consistent patterns",
          "agent": "quality-engineer",
          "validation": {
            "type": "state_field",
            "check": "refactoring_complete == true"
          },
          "outputs": ["refactoring_changes"],
          "skippable_if": "no refactoring needed per quality review"
        },
        {
          "step": "3.4",
          "name": "Re-run Tests After Refactoring",
          "description": "Verify refactoring didn't break anything",
          "agent": "test-runner",
          "validation": {
            "type": "test_status",
            "check": "test_results.failed == 0"
          },
          "outputs": ["test_results"],
          "skippable_if": "step 3.3 was skipped"
        }
      ]
    },
    {
      "phase": 4,
      "name": "Documentation",
      "description": "Generate dialog examples and update docs",
      "steps": [
        {
          "step": "4.1",
          "name": "Generate Documentation",
          "description": "Create dialog example for significant capabilities",
          "agent": "file-creator",
          "validation": {
            "type": "state_field",
            "check": "pre_flight_checklist.dialog_example_created == true"
          },
          "outputs": ["dialog_example_path"],
          "skippable_if": "no significant new capability"
        }
      ]
    },
    {
      "phase": 5,
      "name": "Commit",
      "description": "Verify coverage gate and commit all changes",
      "steps": [
        {
          "step": "5.1",
          "name": "Coverage Gate",
          "description": "Verify test coverage meets 75% threshold before committing",
          "agent": "test-runner",
          "validation": {
            "type": "coverage_check",
            "check": "coverage >= 75%"
          },
          "outputs": ["coverage_percentage"],
          "gate": true,
          "gate_message": "Test coverage must be at least 75% before committing. Current coverage: {coverage_percentage}%"
        },
        {
          "step": "5.2",
          "name": "Git Commit",
          "description": "Stage and commit with proper message format",
          "agent": null,
          "validation": {
            "type": "git_status",
            "check": "working directory clean"
          },
          "outputs": ["commit_hash"]
        }
      ]
    },
    {
      "phase": 6,
      "name": "Completion",
      "description": "Update sprint file, run checklist, move to done, close sprint",
      "steps": [
        {
          "step": "6.1",
          "name": "Update Sprint File",
          "description": "Set status to done, completed date, hours, and check off all tasks in Definition of Done",
          "agent": null,
          "validation": {
            "type": "file_content",
            "check": "sprint file has status: done in frontmatter AND completed date set"
          },
          "outputs": []
        },
        {
          "step": "6.2",
          "name": "Handle Incomplete Items",
          "description": "Get user approval before deferring any items",
          "agent": null,
          "validation": {
            "type": "user_approval",
            "check": "all items complete OR user approved deferral"
          },
          "outputs": []
        },
        {
          "step": "6.3",
          "name": "Pre-Flight Checklist",
          "description": "Verify all 9 checklist items pass",
          "agent": null,
          "validation": {
            "type": "checklist",
            "check": "all pre_flight_checklist items are true"
          },
          "outputs": []
        },
        {
          "step": "6.4",
          "name": "Move Sprint File to Done",
          "description": "REQUIRED: Move sprint file from docs/sprints/2-in-progress/<epic-folder>/ to docs/sprints/4-done/<epic-folder>/",
          "agent": null,
          "validation": {
            "type": "file_location",
            "check": "sprint file exists in docs/sprints/4-done/<epic-folder>/ AND NOT in docs/sprints/2-in-progress/"
          },
          "outputs": ["final_sprint_path"],
          "gate": true,
          "gate_message": "Sprint file MUST be moved to 4-done folder before completing sprint"
        },
        {
          "step": "6.5",
          "name": "Update Sprint README",
          "description": "Update docs/sprints/README.md: remove from In Progress, add to Done section",
          "agent": null,
          "validation": {
            "type": "file_content",
            "check": "README.md lists sprint in Done section, not in In Progress section"
          },
          "outputs": []
        },
        {
          "step": "6.6",
          "name": "Final Commit",
          "description": "Commit the sprint file move and README update",
          "agent": null,
          "validation": {
            "type": "git_status",
            "check": "sprint completion changes committed"
          },
          "outputs": ["completion_commit_hash"]
        }
      ]
    }
  ],
  "step_order": [
    "1.1", "1.2", "1.3", "1.4",
    "2.1", "2.2", "2.3", "2.4",
    "3.1", "3.2", "3.3", "3.4",
    "4.1",
    "5.1", "5.2",
    "6.1", "6.2", "6.3", "6.4", "6.5", "6.6"
  ]
}
